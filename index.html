<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Indemnizaciones Laborales</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JsPDF CDN for PDF generation (CARGA GLOBAL) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Configuración de Tailwind para usar la fuente Inter y nuestros colores
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy-deep': '#1F3A65',
                        'gold-accent': '#D4AD6B',
                        'off-white': '#F9F9F9',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better aesthetics and readability (Navy/Gold Theme) */
        :root {
            --primary-color: #1F3A65; /* Deep Navy Blue for buttons/accents */
            --secondary-color: #D4AD6B; /* Gold/Beige for highlights */
            --background-color: #F9F9F9; /* Off-White background */
            --card-background: #ffffff;
            --text-color: #1F3A65; /* Navy text */
            --subtle-text: #4B5563; /* Gray text for smaller details */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            text-align: center;
            font-weight: 600;
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .tab-button:not(.active):hover {
            background-color: #e5e7eb; /* Subtle hover effect */
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        .result-box {
            background-color: #e5e7eb; /* gray-200 */
        }
        .main-title {
            color: var(--primary-color);
        }
        /* Custom Button Styles using the new primary color */
        .btn-primary-custom {
            background-color: var(--primary-color);
            transition: background-color 0.2s;
        }
        .btn-primary-custom:hover {
            background-color: #162947; /* Slightly darker navy */
        }
        .input-border-focus:focus {
             border-color: var(--secondary-color);
             box-shadow: 0 0 0 3px rgba(212, 173, 107, 0.5);
        }
        .highlight-gold {
            color: var(--secondary-color);
            font-weight: 600;
        }
        /* Style for the text logo placeholder (ND) */
        .text-logo-nd {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px; 
            width: 50px; 
            margin: 0.5rem auto; 
            background-color: var(--gold-accent);
            color: var(--primary-color); /* Navy Blue Text on Gold */
            font-weight: bold;
            font-size: 1.5rem; 
            border-radius: 9999px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border: 2px solid var(--primary-color);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        
        <!-- HEADER AND BRANDING (Updated with Navy/Gold Theme and Logo) -->
        <header class="text-center mb-6 p-4 bg-white rounded-xl shadow-lg border-t-8 border-[var(--primary-color)]">
            
            <!-- LOGO PLACEHOLDER ND -->
            <div class="text-logo-nd">ND</div>
            
            <h1 class="text-2xl font-extrabold main-title pt-1">Calculadora de Liquidación Laboral (LCT)</h1>
            <p class="text-sm highlight-gold">Nanci De Moraiz - Asesoramiento Jurídico Integral</p>
        </header>


        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center mb-8 p-1 bg-white rounded-xl shadow-md border-b-4 border-[var(--secondary-color)]">
            <button id="tab-btn-diferencias-salariales" onclick="changeTab('diferencias-salariales')" class="tab-button active flex-1 px-4 py-3 text-sm font-medium rounded-lg transition-colors duration-200">
                1. Diferencias Salariales (Base de Reclamo)
            </button>
            <button id="tab-btn-indemnizacion" onclick="changeTab('indemnizacion')" class="tab-button flex-1 px-4 py-3 text-sm font-medium rounded-lg transition-colors duration-200">
                2. Liquidación Final (Indemnización y Multas)
            </button>
            <button id="tab-btn-guia-uso" onclick="changeTab('guia-uso')" class="tab-button flex-1 px-4 py-3 text-sm font-medium rounded-lg transition-colors duration-200">
                3. Guía de Uso y Fundamentos
            </button>
        </div>

        <!-- FIREBASE & CORE SETUP (Keep at start of script block) -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            // REMOVED: import 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'; <- Redundante y causa conflicto

            // Check if environment variables are defined, otherwise use fallbacks
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Fallback or empty config */ };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Initialize Firebase only if config is available
            if (Object.keys(firebaseConfig).length > 0) {
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
            } else {
                console.warn("Firebase config not found. State saving disabled.");
                window.db = null;
                window.auth = null;
            }
            
            window.userId = null;
            window.currentDifferencesResult = 0;
            window.isAuthReady = false;

            // Global helper to show the custom modal
            window.showModal = (title, message) => {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                document.getElementById('custom-modal').classList.remove('hidden');
            };

            window.hideModal = () => {
                document.getElementById('custom-modal').classList.add('hidden');
            };

            // Authentication Initialization
            if (window.auth) {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                const signInPromise = initialAuthToken
                    ? signInWithCustomToken(window.auth, initialAuthToken)
                    : signInAnonymously(window.auth);

                signInPromise.then(anonUser => {
                    window.userId = anonUser.user.uid;
                    window.isAuthReady = true;
                    listenForData();
                }).catch(error => {
                    console.error("Firebase Sign In Error. State saving disabled.", error);
                    window.showModal('Error de Conexión', 'No se pudo iniciar sesión en la base de datos para guardar el estado. ' + error.message);
                });
            } else {
                // Fallback if Firebase isn't configured
                window.userId = 'local-user-' + Math.random().toString(36).substring(2, 9);
                window.isAuthReady = true;
            }


            // Firestore Data Listener (Saves and loads basic state)
            function listenForData() {
                if (!window.db || !window.userId || !window.isAuthReady) return;

                const docRef = doc(window.db, "artifacts", appId, "users", window.userId, "calculadora", "state");

                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists() && window.isAuthReady) {
                        const data = docSnap.data();
                        
                        // Load data for Tab 2
                        document.getElementById('nombre-trabajador').value = data.nombreTrabajador || '';
                        document.getElementById('dni-trabajador').value = data.dniTrabajador || '';
                        document.getElementById('cuit-trabajador').value = data.cuitTrabajador || '';
                        document.getElementById('cct-aplicable').value = data.cctAplicable || '';
                        document.getElementById('profesion-trabajador').value = data.profesionTrabajador || '';
                        document.getElementById('mrmnyh-sueldo').value = data.mrmnyh || '';
                        document.getElementById('tope-salarial').value = data.topeSalarial || '';
                        
                        // Load Multa Checkboxes
                        document.getElementById('multa-25323-2').checked = data.multa25323Art2Checked === true;
                        document.getElementById('multa-25323-80').checked = data.multa25323Art80Checked === true;
                        document.getElementById('multa-132bis').checked = data.multa132bisChecked === true;

                        // Load data for Tab 1
                        document.getElementById('sueldo-bruto-mes').value = data.sueldoBrutoMes || '';
                        document.getElementById('base-horaria').value = data.baseHoraria || '200';
                        document.getElementById('horas-extras-50').value = data.horasExtras50 || '0';
                        document.getElementById('horas-extras-100').value = data.horasExtras100 || '0';
                        document.getElementById('feriados-trabajados').value = data.feriadosTrabajados || '0';
                        
                        // Load Differences Result if available
                        window.currentDifferencesResult = parseFloat(data.currentDifferencesResult) || 0;
                        document.getElementById('deuda-diferencias').value = window.currentDifferencesResult.toFixed(2);
                        document.getElementById('resultado-diferencias').textContent = window.formatter.format(window.currentDifferencesResult);

                    }
                }, (error) => {
                    console.error("Firestore Error:", error);
                });
            }

            // Function to save the necessary inputs (called on change)
            window.saveBasicState = async () => {
                if (!window.db || !window.userId || !window.isAuthReady) return;

                try {
                    const dataToSave = {
                        // Tab 2 Worker Data
                        nombreTrabajador: document.getElementById('nombre-trabajador').value,
                        dniTrabajador: document.getElementById('dni-trabajador').value,
                        cuitTrabajador: document.getElementById('cuit-trabajador').value,
                        cctAplicable: document.getElementById('cct-aplicable').value,
                        profesionTrabajador: document.getElementById('profesion-trabajador').value,
                        mrmnyh: document.getElementById('mrmnyh-sueldo').value,
                        topeSalarial: document.getElementById('tope-salarial').value,
                        
                        // Multa Checkboxes
                        multa25323Art2Checked: document.getElementById('multa-25323-2').checked,
                        multa25323Art80Checked: document.getElementById('multa-25323-80').checked,
                        multa132bisChecked: document.getElementById('multa-132bis').checked,

                        // Tab 1 Base Data
                        sueldoBrutoMes: document.getElementById('sueldo-bruto-mes').value,
                        baseHoraria: document.getElementById('base-horaria').value,
                        horasExtras50: document.getElementById('horas-extras-50').value,
                        horasExtras100: document.getElementById('horas-extras-100').value,
                        feriadosTrabajados: document.getElementById('feriados-trabajados').value,
                        currentDifferencesResult: window.currentDifferencesResult,
                    };
                    const docRef = doc(window.db, "artifacts", appId, "users", window.userId, "calculadora", "state");
                    await setDoc(docRef, dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving state:", error);
                }
            };
        </script>


        <!-- TAB: 1. Diferencias Salariales (Base de Reclamo) -->
        <div id="diferencias-salariales-tab" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-2 text-[var(--primary-color)]">1. Diferencias Salariales (Horas, Feriados)</h2>
            <p class="mb-4 text-sm text-[var(--subtle-text)]">Calcula la deuda del empleador por horas nocturnas y suplementarias para integrarla a la liquidación final.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Sueldo Bruto Mensual (Base de Cálculo) -->
                <div class="input-group">
                    <label for="sueldo-bruto-mes" class="block text-sm font-medium text-[var(--text-color)]">Sueldo Bruto Mensual a Recalcular (MRMNyH)</label>
                    <input type="number" id="sueldo-bruto-mes" placeholder="Ej: 1800000" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Sueldo percibido por el trabajador en el mes a reclamar (el más alto del último año para horas extras).</p>
                </div>

                <!-- Base Horaria -->
                <div class="input-group">
                    <label for="base-horaria" class="block text-sm font-medium text-[var(--text-color)]">Base Horaria Mensual del CCT</label>
                    <input type="number" id="base-horaria" value="200" min="168" max="200" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Horas mensuales que establece el Convenio (ej: 200, 192, 180). Se usará para calcular el valor de la hora normal (Sueldo / Nro de Horas).</p>
                </div>
                
                <!-- Meses a Reclamar -->
                <div class="input-group">
                    <label for="meses-reclamar" class="block text-sm font-medium text-[var(--text-color)]">Meses a Reclamar (Prescripción LCT)</label>
                    <input type="number" id="meses-reclamar" value="24" min="1" max="24" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Máximo 24 meses (2 años) hacia atrás para deudas salariales.</p>
                </div>

                <!-- Horario de Trabajo Habitual (Para cálculo de Nocturnas) -->
                <div class="input-group">
                    <label class="block text-sm font-medium text-[var(--text-color)]">Horario de Trabajo Habitual (Entrada - Salida)</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="time" id="hora-entrada" value="09:00" class="block w-1/2 rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                        <input type="time" id="hora-salida" value="17:00" class="block w-1/2 rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                    </div>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Se usará para calcular automáticamente las horas nocturnas (21:00 a 06:00).</p>
                </div>

                <!-- Horas Extras 50% -->
                <div class="input-group">
                    <label for="horas-extras-50" class="block text-sm font-medium text-[var(--text-color)]">Horas Extras al 50% No Abonadas (TOTAL)</label>
                    <input type="number" id="horas-extras-50" value="0" min="0" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Suma de horas extras del 50% (lunes a sábado 13:00) en el período reclamado.</p>
                </div>

                <!-- Horas Extras 100% -->
                <div class="input-group">
                    <label for="horas-extras-100" class="block text-sm font-medium text-[var(--text-color)]">Horas Extras al 100% No Abonadas (TOTAL)</label>
                    <input type="number" id="horas-extras-100" value="0" min="0" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Suma de horas extras del 100% (sábados post 13:00, domingos) en el período reclamado.</p>
                </div>

                <!-- Feriados Trabajados (Manual) -->
                <div class="input-group">
                    <label for="feriados-trabajados" class="block text-sm font-medium text-[var(--text-color)]">Feriados Trabajados y NO Abonados (Cantidad)</label>
                    <input type="number" id="feriados-trabajados" value="0" min="0" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm input-border-focus p-2 border" required>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Cantidad total de feriados trabajados y no abonados en el período reclamado (asume 8hs por feriado).</p>
                </div>

            </div>

            <button onclick="calculateSalaryDifferences()" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 mt-6 shadow-lg btn-primary-custom">
                CALCULAR DIFERENCIAS SALARIALES Y CONTINUAR →
            </button>

            <!-- Display Results -->
            <div id="diferencias-results" class="mt-8 p-4 bg-gray-50 rounded-xl hidden border border-[var(--secondary-color)]">
                <h3 class="text-xl font-semibold mb-4 text-[var(--primary-color)]">Resultado de la Deuda Salarial Total</h3>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-sm font-medium text-[var(--subtle-text)]">Monto Total de Diferencias Reclamadas (24 meses)</span>
                    <span id="resultado-diferencias" class="text-lg font-bold text-[var(--primary-color)]">$ 0.00</span>
                </div>
                <p class="text-xs text-[var(--subtle-text)] mt-2">Este monto se trasladará a la Pestaña 2 para su inclusión en la Liquidación Final.</p>
            </div>
        </div>

        <!-- TAB: 2. Liquidación Final (Indemnización y Multas) -->
        <div id="indemnizacion-tab" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-2 text-[var(--primary-color)]">2. Liquidación Final (Indemnización, Multas, Intereses)</h2>
            <p class="mb-4 text-sm text-[var(--subtle-text)]">Calcula la liquidación final, incluyendo las multas e intereses basados en la LCT.</p>

            <!-- DATOS DEL TRABAJADOR -->
            <div class="input-group md:col-span-2 p-4 bg-gray-50 rounded-xl mb-6 border-l-4 border-[var(--secondary-color)]">
                <h3 class="text-lg font-semibold mb-4 text-[var(--primary-color)] border-b border-gray-200 pb-2">Datos del Trabajador</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group !mb-0">
                        <label for="nombre-trabajador" class="block text-sm font-medium text-[var(--text-color)]">Nombre y Apellido</label>
                        <input type="text" id="nombre-trabajador" placeholder="Ej: Juan Pérez" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus" required>
                    </div>
                    <div class="input-group !mb-0">
                        <label for="dni-trabajador" class="block text-sm font-medium text-[var(--text-color)]">DNI</label>
                        <input type="text" id="dni-trabajador" placeholder="Ej: 12345678" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus">
                    </div>
                    <div class="input-group !mb-0">
                        <label for="cuit-trabajador" class="block text-sm font-medium text-[var(--text-color)]">CUIT</label>
                        <input type="text" id="cuit-trabajador" placeholder="Ej: 20-XXXXXXXX-X" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus">
                    </div>
                    <div class="input-group !mb-0">
                        <label for="cct-aplicable" class="block text-sm font-medium text-[var(--text-color)]">CCT Aplicable</label>
                        <input type="text" id="cct-aplicable" placeholder="Ej: 130/75 (Comercio)" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus">
                    </div>
                    <div class="input-group !mb-0 sm:col-span-2">
                        <label for="profesion-trabajador" class="block text-sm font-medium text-[var(--text-color)]">Profesión/Categoría</label>
                        <input type="text" id="profesion-trabajador" placeholder="Ej: Administrativo" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Data Input Fields -->
                <div class="input-group">
                    <label for="fecha-ingreso" class="block text-sm font-medium text-[var(--text-color)]">Fecha de Ingreso</label>
                    <input type="date" id="fecha-ingreso" value="2022-01-01" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus" required>
                </div>
                <div class="input-group">
                    <label for="fecha-egreso" class="block text-sm font-medium text-[var(--text-color)]">Fecha de Egreso / Fecha de Liquidación</label>
                    <input type="date" id="fecha-egreso" value="2024-01-01" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus" required>
                </div>
                <div class="input-group">
                    <label for="mrmnyh-sueldo" class="block text-sm font-medium text-[var(--text-color)]">MRMNyH (Art. 245) - Sueldo Base</label>
                    <input type="number" id="mrmnyh-sueldo" placeholder="Sueldo más alto del último año" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus" required>
                </div>
                <div class="input-group">
                    <label for="tope-salarial" class="block text-sm font-medium text-[var(--text-color)]">Tope Salarial CCT (Art. 245)</label>
                    <!-- Eliminado required para permitir campo vacío (usan MRMNyH) -->
                    <input type="number" id="tope-salarial" placeholder="Opcional. Dejar vacío si es igual al sueldo." onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border input-border-focus">
                </div>

                <!-- Nuevo Campo para Diferencias Salariales -->
                <div class="input-group md:col-span-2">
                    <label for="deuda-diferencias" class="block text-sm font-medium text-[var(--primary-color)]">Deuda por Diferencias Salariales (Horas, etc.)</label>
                    <input type="number" id="deuda-diferencias" value="0" class="mt-1 block w-full rounded-md border-[var(--primary-color)] shadow-sm p-2 border bg-blue-50 text-[var(--primary-color)] font-bold" readonly>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Este valor se carga automáticamente desde la Pestaña 1.</p>
                </div>

                <div class="input-group md:col-span-2 border-t pt-4">
                    <h3 class="text-lg font-semibold mb-4 text-[var(--primary-color)]">Multas e Intereses</h3>
                    
                    <!-- Multa Art. 2 Ley 25.323 -->
                    <div class="flex items-center mb-2">
                        <input id="multa-25323-2" type="checkbox" onchange="saveBasicState()" class="h-4 w-4 text-[var(--primary-color)] border-gray-300 rounded focus:ring-[var(--primary-color)]">
                        <label for="multa-25323-2" class="ml-2 block text-sm font-medium text-[var(--text-color)]">Multa Art. 2 Ley 25.323 (50% por reclamo judicial)</label>
                    </div>

                    <!-- Multa Art. 80 LCT -->
                    <div class="flex items-center mb-2">
                        <input id="multa-25323-80" type="checkbox" onchange="saveBasicState()" class="h-4 w-4 text-[var(--primary-color)] border-gray-300 rounded focus:ring-[var(--primary-color)]">
                        <label for="multa-25323-80" class="ml-2 block text-sm font-medium text-[var(--text-color)]">Multa Art. 80 LCT (3x MRMNyH por falta de entrega de certificado)</label>
                    </div>

                    <!-- Multa Art. 132 bis LCT -->
                    <div class="flex items-center mb-2">
                        <input id="multa-132bis" type="checkbox" onchange="saveBasicState()" class="h-4 w-4 text-[var(--primary-color)] border-gray-300 rounded focus:ring-[var(--primary-color)]">
                        <label for="multa-132bis" class="ml-2 block text-sm font-medium text-[var(--text-color)]">Multa Art. 132 bis LCT (Duplicación por falta de aportes)</label>
                    </div>


                    <!-- Intereses Moratorios -->
                    <div class="flex items-center space-x-4 mt-4">
                        <label for="interes-anual" class="text-sm font-medium text-[var(--text-color)]">Tasa de Interés Moratorio Anual (ej: 30%)</label>
                        <input type="number" id="interes-anual" value="0" min="0" max="100" class="w-20 rounded-md border-gray-300 shadow-sm p-2 border text-right input-border-focus">
                        <span class="text-sm">%</span>
                    </div>
                    <p class="text-xs text-[var(--subtle-text)] mt-1">Se aplica sobre el Total Bruto sin Multas, multiplicado por los años de antigüedad (simulación de intereses judiciales).</p>
                </div>

            </div>

            <button onclick="calculateSeverance()" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 mt-6 shadow-lg btn-primary-custom">
                CALCULAR LIQUIDACIÓN FINAL
            </button>

            <!-- Results Section -->
            <div id="indemnizacion-results" class="mt-8 p-6 bg-gray-50 rounded-xl border-t-8 border-[var(--secondary-color)] hidden">
                <h3 class="text-xl font-bold mb-4 text-[var(--primary-color)]">RESULTADO DE LA LIQUIDACIÓN</h3>
                <div class="space-y-3">
                    <div class="flex justify-between font-medium text-gray-700 py-1">
                        <span>Antigüedad (Años y Meses)</span>
                        <span id="res-antiguedad" class="highlight-gold">0 años, 0 meses</span>
                    </div>
                    <div class="flex justify-between font-medium text-gray-700 py-1 border-t pt-2">
                        <span>Base de Cálculo Art. 245 (Tope Salarial vs. MRMNyH)</span>
                        <span id="res-base-calculo" class="highlight-gold">$ 0.00</span>
                    </div>

                    <!-- Rubros Indemnizatorios -->
                    <div class="bg-gray-100 p-3 rounded-lg space-y-2 border-l-4 border-[var(--primary-color)]">
                        <h4 class="text-md font-semibold text-[var(--primary-color)]">Indemnización Base</h4>
                        <div class="flex justify-between">
                            <span class="text-sm">Indemnización por Antigüedad (Art. 245)</span>
                            <span id="res-antiguedad-monto">$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Indemnización por Preaviso (+ SAC y Vacaciones)</span>
                            <span id="res-preaviso-monto">$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Integración Mes Despido (Días / 30)</span>
                            <span id="res-integracion-monto">$ 0.00</span>
                        </div>
                    </div>

                    <!-- Rubros Adicionales/Deuda -->
                    <div class="bg-yellow-50 p-3 rounded-lg space-y-2 border-l-4 border-[var(--secondary-color)]">
                        <h4 class="text-md font-semibold text-yellow-800">Deudas y Otros Rubros</h4>
                        <div class="flex justify-between">
                            <span class="text-sm">Vacaciones No Gozadas (Días Proporcionales)</span>
                            <span id="res-vacaciones-monto">$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">SAC Proporcional sobre Haberes</span>
                            <span id="res-sac-proporcional">$ 0.00</span>
                        </div>
                        <div class="flex justify-between font-bold text-[var(--primary-color)]">
                            <span class="text-sm">Deuda por Diferencias Salariales (Horas, Feriados)</span>
                            <span id="res-diferencias-deuda">$ 0.00</span>
                        </div>
                    </div>
                    
                    <!-- Subtotal y Multas -->
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between font-bold text-gray-800">
                            <span>SUBTOTAL BRUTO SIN MULTAS</span>
                            <span id="res-subtotal-bruto">$ 0.00</span>
                        </div>

                        <h4 class="text-md font-semibold text-[var(--primary-color)] pt-2">Multas LCT</h4>
                        <div id="res-multa-2-row" class="flex justify-between hidden">
                            <span class="text-sm">Multa Art. 2 Ley 25.323 (50% sobre Indemnización Base)</span>
                            <span id="res-multa-2">$ 0.00</span>
                        </div>
                        <div id="res-multa-80-row" class="flex justify-between hidden">
                            <span class="text-sm">Multa Art. 80 LCT (3 x MRMNyH)</span>
                            <span id="res-multa-80">$ 0.00</span>
                        </div>
                        <div id="res-multa-132bis-row" class="flex justify-between hidden">
                            <span class="text-sm font-semibold text-[var(--primary-color)]">Multa Art. 132 bis LCT (Duplicación por aportes)</span>
                            <span id="res-multa-132bis-monto" class="font-semibold text-[var(--primary-color)]">$ 0.00</span>
                        </div>
                    </div>

                    <!-- Intereses y Total Final -->
                    <div class="border-t border-b py-4 mt-4 space-y-2">
                            <div class="flex justify-between font-bold text-green-700">
                                <span>Intereses Moratorios Aplicados</span>
                                <span id="res-intereses">$ 0.00</span>
                            </div>
                            <div class="flex justify-between text-xl font-extrabold text-[var(--primary-color)]">
                                <span>TOTAL ESTIMADO FINAL RECLAMABLE</span>
                                <span id="res-total-final" class="text-2xl highlight-gold">$ 0.00</span>
                            </div>
                    </div>
                </div>
                <p class="text-xs text-[var(--subtle-text)] mt-4">NOTA: Este total es una estimación. Los intereses y la aplicación de multas deben ser confirmados por un profesional.</p>
                <button onclick="generatePDF()" class="w-full text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 mt-4 shadow-md btn-primary-custom">
                    GENERAR INFORME PDF
                </button>
            </div>
        </div>

        <!-- TAB: 3. Guía de Uso y Fundamentos -->
        <div id="guia-uso-tab" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-2 text-[var(--primary-color)]">3. Guía de Uso y Fundamentos Legales</h2>
            <div class="space-y-6 text-[var(--subtle-text)]">
                <section>
                    <h3 class="text-xl font-bold text-[var(--primary-color)] mb-2">Instrucciones de Uso Sencillas</h3>
                    <p>Esta herramienta lo guía en dos pasos para obtener una estimación completa de la liquidación final por despido.</p>
                    <ol class="list-decimal list-inside space-y-3 ml-4">
                        <li><span class="font-bold">Pestaña 1 (Diferencias Salariales):</span> 
                            <p class="ml-4 mt-1 text-sm">Use esta sección para calcular cualquier monto de dinero que el empleador le deba por salarios, horas extras o feriados no pagos en los últimos 2 años. Ingrese el sueldo bruto más alto del período y la **Base Horaria** de su convenio para establecer el valor de la hora. El resultado se guarda automáticamente.</p>
                        </li>
                        <li><span class="font-bold">Pestaña 2 (Liquidación Final):</span> 
                            <p class="ml-4 mt-1 text-sm">El monto de la **Deuda Salarial** (Pestaña 1) se traslada automáticamente aquí. Ingrese sus fechas de trabajo (Ingreso y Egreso) y los dos montos clave: la **MRMNyH** (Sueldo más alto del último año) y el **Tope Salarial** de su CCT. Si no conoce el tope, déjelo vacío; usaremos la MRMNyH.</p>
                        </li>
                        <li><span class="font-bold">Multas y Cálculo:</span> 
                            <p class="ml-4 mt-1 text-sm">Seleccione las **Multas** aplicables según la situación (por ejemplo, si no le entregaron el certificado de trabajo). Luego presione **CALCULAR LIQUIDACIÓN FINAL** para ver el detalle y el monto total.</p>
                        </li>
                    </ol>
                </section>

                <section>
                    <h3 class="text-xl font-bold text-[var(--primary-color)] mb-2">Glosario Legal (Conceptos Clave de la LCT)</h3>
                    <ul class="list-disc list-inside space-y-3 ml-4">
                        <li><span class="highlight-gold font-bold">MRMNyH (Mejor Remuneración Mensual Normal y Habitual):</span>
                            <p class="ml-4 mt-1 text-sm">Es el sueldo bruto más alto que cobró el trabajador en el último año. Este monto se usa como base para la mayoría de las indemnizaciones, como el preaviso.</p>
                        </li>
                        <li><span class="highlight-gold font-bold">Tope Salarial (Art. 245):</span>
                            <p class="ml-4 mt-1 text-sm">Es el límite máximo que se puede usar para calcular la Indemnización por Antigüedad. Este valor lo establece el Ministerio de Trabajo según el CCT. Si su MRMNyH es mayor a este tope, la indemnización se calcula usando el tope.</p>
                        </li>
                        <li><span class="highlight-gold font-bold">Antigüedad (Redondeo):</span>
                            <p class="ml-4 mt-1 text-sm">Según la ley, si trabajó una fracción de tiempo mayor a 3 meses en el último año, ese año se cuenta como completo para la indemnización. Por ejemplo, si trabajó 4 años y 4 meses, se le pagan 5 años.</p>
                        </li>
                        <li><span class="highlight-gold font-bold">Multa Art. 2 Ley 25.323 (50%):</span>
                            <p class="ml-4 mt-1 text-sm">Se aplica si el empleador no paga la liquidación final a tiempo y usted se ve obligado a hacer un reclamo judicial. Se suma un 50% extra sobre el monto de la indemnización base.</p>
                        </li>
                    </ul>
                </section>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Alerts/Errors (Replaces alert()) -->
    <div id="custom-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full border-t-8 border-[var(--primary-color)]">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-[var(--primary-color)]">Error</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Mensaje de error o alerta.</p>
            <button onclick="hideModal()" class="w-full text-white py-2 rounded-lg transition-colors duration-200 btn-primary-custom">Aceptar</button>
        </div>
    </div>


    <!-- MAIN JAVASCRIPT LOGIC -->
    <script type="text/javascript">
        // Global utility function to format currency
        const formatter = new Intl.NumberFormat('es-AR', {
            style: 'currency',
            currency: 'ARS',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
        window.formatter = formatter; // Make available globally

        // Function to switch tabs
        window.changeTab = (tabName) => {
            const tabs = ['diferencias-salariales', 'indemnizacion', 'guia-uso'];
            tabs.forEach(tab => {
                document.getElementById(`${tab}-tab`).classList.add('hidden');
                document.getElementById(`tab-btn-${tab}`).classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        };
        
        // Initial load: show the first tab
        document.addEventListener('DOMContentLoaded', () => {
             // Ensure the global functions exist before trying to use them on load
             if (typeof window.hideModal !== 'function') {
                 // Fallback definition for the modal utility if not loaded via module
                 window.showModal = (title, message) => {
                    document.getElementById('modal-title').textContent = title;
                    document.getElementById('modal-message').textContent = message;
                    document.getElementById('custom-modal').classList.remove('hidden');
                 };
                 window.hideModal = () => {
                    document.getElementById('custom-modal').classList.add('hidden');
                 };
             }
             changeTab('diferencias-salariales');
        });

        // Function to calculate the difference in hours between two times
        function calculateHoursDifference(start, end) {
            const startParts = start.split(':').map(Number);
            const endParts = end.split(':').map(Number);

            const startDate = new Date(0, 0, 0, startParts[0], startParts[1]);
            let endDate = new Date(0, 0, 0, endParts[0], endParts[1]);

            // If end time is earlier than start time, it means the shift crosses midnight
            if (endDate <= startDate) {
                endDate.setDate(endDate.getDate() + 1); // Add one day
            }

            return (endDate - startDate) / (1000 * 60 * 60); // Difference in hours
        }

        /**
         * --------------------------------------------------------
         * PESTAÑA 1: CALCULADORA DE DIFERENCIAS SALARIALES
         * --------------------------------------------------------
         */
        window.calculateSalaryDifferences = () => {
            // Asegurar que los valores por defecto se toman si no hay input
            const sueldoBrutoMensual = parseFloat(document.getElementById('sueldo-bruto-mes').value || 0);
            const mesesReclamar = parseInt(document.getElementById('meses-reclamar').value || 0);
            const horaEntrada = document.getElementById('hora-entrada').value;
            const horaSalida = document.getElementById('hora-salida').value;
            const horasExtras50 = parseFloat(document.getElementById('horas-extras-50').value || 0);
            const horasExtras100 = parseFloat(document.getElementById('horas-extras-100').value || 0);
            const feriadosTrabajados = parseInt(document.getElementById('feriados-trabajados').value || 0);
            const baseHorariaCCT = parseInt(document.getElementById('base-horaria').value || 200);

            if (sueldoBrutoMensual <= 0 || mesesReclamar === 0 || mesesReclamar > 24 || baseHorariaCCT < 168) {
                showModal('Datos Incompletos', 'Por favor, ingrese un Sueldo Bruto válido, la cantidad de meses (máx. 24) y una Base Horaria del CCT (mín. 168).');
                return;
            }

            // 1. CÁLCULO DE VALOR DE HORA NORMAL
            const valorHoraNormal = sueldoBrutoMensual / baseHorariaCCT;

            // 2. CÁLCULO DE HORAS NOCTURNAS (21:00 a 06:00)
            const NOCTURNO_START = 21;
            const NOCTURNO_END = 6;
            const ADICIONAL_NOCTURNO = 0.1333; // 13.33% diferencia a reclamar
            const DIAS_LABORABLES_MES = 21; // Estimate for working days

            let horasNocturnasPorDia = 0;
            let totalHorasTrabajadas = calculateHoursDifference(horaEntrada, horaSalida);

            // Calculate overlap with nocturnal hours (simplified)
            for (let h = 0; h < totalHorasTrabajadas; h++) {
                let entryHour = parseFloat(horaEntrada.split(':')[0]);
                let hourOfDay = (entryHour + h) % 24;

                if (hourOfDay >= NOCTURNO_START || hourOfDay < NOCTURNO_END) {
                    horasNocturnasPorDia++;
                }
            }
            
            const totalHorasNocturnasPeriodo = horasNocturnasPorDia * DIAS_LABORABLES_MES * mesesReclamar;
            const diferenciaNocturna = totalHorasNocturnasPeriodo * valorHoraNormal * ADICIONAL_NOCTURNO;
            
            // 3. CÁLCULO DE HORAS EXTRAS Y FERIADOS (Diferencia a reclamar)
            const diferenciaExtras50 = horasExtras50 * valorHoraNormal * 0.50;
            const diferenciaExtras100 = horasExtras100 * valorHoraNormal * 1.00;

            // Feriados no abonados (Asumimos 8 horas por feriado, se reclama el 100%)
            const diferenciaFeriados = feriadosTrabajados * 8 * valorHoraNormal * 1.00;

            // 4. TOTALIZACIÓN
            const totalDiferenciasSalariales = diferenciaNocturna + diferenciaExtras50 + diferenciaExtras100 + diferenciaFeriados;
            
            // Update Global State
            window.currentDifferencesResult = totalDiferenciasSalariales;

            // Display Results in Tab 1
            document.getElementById('resultado-diferencias').textContent = formatter.format(totalDiferenciasSalariales);
            document.getElementById('diferencias-results').classList.remove('hidden');

            // Pass result to Tab 2 and switch
            document.getElementById('deuda-diferencias').value = totalDiferenciasSalariales.toFixed(2);
            
            showModal('Cálculo Realizado', `La Deuda Salarial de ${formatter.format(totalDiferenciasSalariales)} ha sido calculada y transferida a la Pestaña 2 para finalizar la liquidación.`);
            changeTab('indemnizacion');
            window.saveBasicState();
        };


        /**
         * --------------------------------------------------------
         * PESTAÑA 2: CALCULADORA DE INDEMNIZACIONES FINALES
         * --------------------------------------------------------
         */
        window.calculateSeverance = () => {
            const fechaIngreso = document.getElementById('fecha-ingreso').value;
            const fechaEgreso = document.getElementById('fecha-egreso').value;
            let mrmnyh = parseFloat(document.getElementById('mrmnyh-sueldo').value || 0);
            let topeSalarialInput = parseFloat(document.getElementById('tope-salarial').value || 0); // Input puede ser 0 si está vacío
            const deudaDiferencias = parseFloat(document.getElementById('deuda-diferencias').value || 0);
            
            // Checkboxes para las multas
            const multa25323Art2 = document.getElementById('multa-25323-2').checked;
            const multa25323Art80 = document.getElementById('multa-25323-80').checked;
            const multa132bis = document.getElementById('multa-132bis').checked;
            
            const interesAnual = parseFloat(document.getElementById('interes-anual').value || 0) / 100;

            // Validar que los campos críticos tengan valores
            if (!fechaIngreso || !fechaEgreso || mrmnyh <= 0) {
                showModal('Datos Incompletos', 'Por favor, complete las Fechas de Ingreso/Egreso y el MRMNyH. Estos no pueden estar vacíos o ser cero.');
                return;
            }

            const start = new Date(fechaIngreso + "T00:00:00");
            const end = new Date(fechaEgreso + "T00:00:00");

            if (start >= end) {
                showModal('Error de Fecha', 'La fecha de egreso debe ser posterior a la fecha de ingreso.');
                return;
            }

            // A. CÁLCULO DE ANTIGÜEDAD Y BASE DE CÁLCULO
            const diffTime = Math.abs(end - start);
            const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
            const years = Math.floor(diffYears);
            const months = Math.floor((diffYears - years) * 12);
            const daysRemaining = Math.floor((diffYears * 365.25) - (years * 365.25) - (months * (365.25/12)));


            // Para Indemnización por Antigüedad: Art. 245
            let antiguedadAnios = years;
            // Si la antigüedad es 3 meses o más en el último año, se redondea al año superior.
            // Para el primer año, si trabajó 3 meses o más, se computa 1 año.
            const totalDaysWorked = diffTime / (1000 * 60 * 60 * 24);
            if (totalDaysWorked >= 90 && antiguedadAnios === 0) {
                 antiguedadAnios = 1;
            } else if (months >= 3) {
                 antiguedadAnios += 1;
            } else if (antiguedadAnios === 0 && totalDaysWorked < 90) {
                 antiguedadAnios = 0; // Menos de 90 días, no corresponde Art 245
            }
            
            // Determinar la Base de Cálculo (BCC): el menor entre MRMNyH y Tope Salarial
            let baseCalculoArt245 = mrmnyh; 
            let topeSalarialDisplay = mrmnyh;

            if (topeSalarialInput > 0 && topeSalarialInput < mrmnyh) {
                baseCalculoArt245 = topeSalarialInput;
                topeSalarialDisplay = topeSalarialInput;
            } else {
                 // Si tope es 0 o mayor a MRMNyH, se usa MRMNyH (se setea topeSalarialDisplay para el PDF)
                 topeSalarialDisplay = mrmnyh;
            }


            // B. RUBROS INDEMNIZATORIOS BASE
            let indemAntiguedad = baseCalculoArt245 * antiguedadAnios;

            // Preaviso (Art. 232 LCT) - Mínimo 1 mes si antig. es < 5 años, 2 meses si es >= 5 años
            let mesesPreaviso;
            if (years === 0) {
                 mesesPreaviso = 1; // 1 mes de preaviso si no hay antigüedad, típicamente.
            } else {
                 mesesPreaviso = years < 5 ? 1 : 2; 
            }
            let indemPreaviso = baseCalculoArt245 * mesesPreaviso;

            // Integración Mes Despido (Art. 233 LCT)
            const dayOfEgress = end.getDate();
            const lastDayOfMonth = new Date(end.getFullYear(), end.getMonth() + 1, 0).getDate();
            const daysToIntegrate = lastDayOfMonth - dayOfEgress;
            let indemIntegracion = (baseCalculoArt245 / lastDayOfMonth) * daysToIntegrate;
            if (indemIntegracion < 0) indemIntegracion = 0; 
            if (indemIntegracion > baseCalculoArt245) indemIntegracion = baseCalculoArt245; // Max 1 mes

            // C. OTROS RUBROS
            // Vacaciones No Gozadas (Art. 150/156 LCT)
            const daysWorkedThisYear = Math.ceil((end - new Date(end.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
            let daysEntitlement = 14;
            if (years >= 5 && years < 10) daysEntitlement = 21;
            else if (years >= 10 && years < 20) daysEntitlement = 28;
            else if (years >= 20) daysEntitlement = 35;

            const proportionalVacationDays = (daysWorkedThisYear / 365) * daysEntitlement;
            let indemVacaciones = (baseCalculoArt245 / 25) * proportionalVacationDays; // Indemnizatory divisor is 25

            // SAC Proporcional (Art. 121 LCT)
            const monthsWorkedThisSemester = (end.getMonth() >= 6) ? (end.getMonth() - 5) + (end.getDate()/30.4375) : (end.getMonth() + 1) + (end.getDate()/30.4375);
            let indemSacProporcional = (mrmnyh * monthsWorkedThisSemester) / 12;
            
            // SAC sobre Indemnización por Preaviso y Integración (se consideran remuneraciones)
            let sacPreaviso = indemPreaviso * 0.0833;
            let sacIntegracion = indemIntegracion * 0.0833;

            // Update indemnity with SAC
            indemPreaviso += sacPreaviso;
            indemIntegracion += sacIntegracion;

            // D. SUBTOTAL BRUTO
            const subTotalBase = indemAntiguedad + indemPreaviso + indemIntegracion + indemVacaciones + indemSacProporcional;
            let subTotalConDeuda = subTotalBase + deudaDiferencias;

            // E. MULTAS
            let multasTotal = 0;
            let multa25323Art2Monto = 0;
            let multa25323Art80Monto = 0;
            let multa132bisMonto = 0;
            
            // Multa Art. 2 Ley 25.323 (50%)
            if (multa25323Art2) {
                multa25323Art2Monto = (indemAntiguedad + indemPreaviso + indemIntegracion) * 0.50;
                multasTotal += multa25323Art2Monto;
                document.getElementById('res-multa-2-row').classList.remove('hidden');
            } else {
                document.getElementById('res-multa-2-row').classList.add('hidden');
            }

            // Multa Art. 80 LCT (3 x MRMNyH)
            if (multa25323Art80) {
                multa25323Art80Monto = mrmnyh * 3;
                multasTotal += multa25323Art80Monto;
                document.getElementById('res-multa-80-row').classList.remove('hidden');
            } else {
                document.getElementById('res-multa-80-row').classList.add('hidden');
            }


            // Multa Art. 132 bis LCT (Duplicación)
            if (multa132bis) {
                // Duplica la Indemnización Base (Antigüedad + Preaviso + Integración)
                multa132bisMonto = indemAntiguedad + indemPreaviso + indemIntegracion;
                multasTotal += multa132bisMonto;
                document.getElementById('res-multa-132bis-row').classList.remove('hidden');
            } else {
                document.getElementById('res-multa-132bis-row').classList.add('hidden');
            }
            
            // F. INTERESES MORATORIOS
            let totalIntereses = 0;
            if (interesAnual > 0) {
                // Cálculo simple: (Total Bruto sin Multas) * Tasa * Años de Antigüedad
                totalIntereses = subTotalConDeuda * interesAnual * diffYears; // Use full years with fraction
            }

            // G. TOTAL FINAL RECLAMABLE
            const totalFinal = subTotalConDeuda + multasTotal + totalIntereses;


            // H. MOSTRAR RESULTADOS
            document.getElementById('res-antiguedad').textContent = `${years} años, ${months} meses (${daysRemaining} días)`;
            document.getElementById('res-base-calculo').textContent = formatter.format(baseCalculoArt245);
            document.getElementById('res-antiguedad-monto').textContent = formatter.format(indemAntiguedad);
            document.getElementById('res-preaviso-monto').textContent = formatter.format(indemPreaviso);
            document.getElementById('res-integracion-monto').textContent = formatter.format(indemIntegracion);
            document.getElementById('res-vacaciones-monto').textContent = formatter.format(indemVacaciones);
            document.getElementById('res-sac-proporcional').textContent = formatter.format(indemSacProporcional);
            document.getElementById('res-diferencias-deuda').textContent = formatter.format(deudaDiferencias);
            document.getElementById('res-subtotal-bruto').textContent = formatter.format(subTotalConDeuda);
            document.getElementById('res-multa-2').textContent = formatter.format(multa25323Art2Monto);
            document.getElementById('res-multa-80').textContent = formatter.format(multa25323Art80Monto);
            document.getElementById('res-multa-132bis-monto').textContent = formatter.format(multa132bisMonto);
            document.getElementById('res-intereses').textContent = formatter.format(totalIntereses);
            document.getElementById('res-total-final').textContent = formatter.format(totalFinal);

            document.getElementById('indemnizacion-results').classList.remove('hidden');
            
            // Guardamos los datos para el PDF
            window.pdfData = {
                nombreTrabajador: document.getElementById('nombre-trabajador').value || 'N/A',
                dniTrabajador: document.getElementById('dni-trabajador').value || 'N/A',
                cuitTrabajador: document.getElementById('cuit-trabajador').value || 'N/A',
                cctAplicable: document.getElementById('cct-aplicable').value || 'N/A',
                profesionTrabajador: document.getElementById('profesion-trabajador').value || 'N/A',
                fechaIngreso: fechaIngreso,
                fechaEgreso: fechaEgreso,
                mrmnyh: mrmnyh,
                topeSalarialDisplay: topeSalarialDisplay, // Usamos el valor efectivo
                antiguedadDisplay: `${years} años, ${months} meses (${daysRemaining} días)`,
                deudaDiferencias: deudaDiferencias,
                interesAnual: interesAnual * 100,
            };

            // Save state
            window.saveBasicState();
        };

        /**
         * --------------------------------------------------------
         * GENERACIÓN DE PDF (Corregida la referencia de datos)
         * --------------------------------------------------------
         */
        window.generatePDF = async () => {
            // Check for jsPDF availability
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                showModal('Error de PDF', 'La librería de PDF no está disponible. Por favor, intente recargar la página.');
                return;
            }
            if (!window.pdfData) {
                showModal('Cálculo Faltante', 'Debe presionar "CALCULAR LIQUIDACIÓN FINAL" antes de generar el informe.');
                return;
            }

            // Acceder al constructor desde el objeto global window.jspdf de forma robusta
            try {
                // Uso directo del constructor del objeto global jspdf.
                const jsPDF = window.jspdf.jsPDF; 
                if (typeof jsPDF === 'undefined') {
                    throw new Error("Constructor jsPDF no disponible.");
                }
                const doc = new jsPDF();
                
                const margin = 15;
                let y = margin;
                const lineHeight = 7;
                const maxWidth = 180;
                const data = window.pdfData;
                
                // --- Función para obtener el texto del rubro y asegurarnos de que sea string ---
                const getRubroText = (id) => String(document.getElementById(id).textContent);


                // 1. HEADER AND LOGO (ND Placeholder)
                y += 5;
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(31, 58, 101); // Navy Deep (RGB)
                
                // --- AJUSTE DE ALINEACIÓN DEL LOGO ---
                const logoX = margin + 5; // Centro del círculo en X
                const logoY = y + 5;      // Centro del círculo en Y

                // Dibujar Círculo (Gold Accent)
                doc.setDrawColor(212, 173, 107); // Gold Accent (RGB)
                doc.setLineWidth(1);
                doc.circle(logoX, logoY, 8); // Círculo centrado en (logoX, logoY)

                // Texto "ND"
                doc.setTextColor(31, 58, 101); // Navy Deep (RGB)
                // Usamos text con align: 'center' para centrar el texto dentro del círculo
                doc.text("ND", logoX, logoY + 2, { align: 'center' }); 
                
                doc.setTextColor(0); // Black

                // Títulos
                const titleX = margin + 35; // Posición de inicio del título
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text("INFORME DE LIQUIDACIÓN LABORAL", titleX, y + 5);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text("NANCI DE MORAIZ - ASESORAMIENTO JURÍDICO INTEGRAL", titleX, y + 12);
                
                y += 25; // Move down past header

                // 2. DATOS DEL TRABAJADOR
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(31, 58, 101); // Navy
                doc.text("DATOS DEL TRABAJADOR Y EMPLEO", margin, y);
                y += lineHeight;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0); // Black

                const workerData = [
                    `Nombre: ${data.nombreTrabajador}`,
                    `DNI: ${data.dniTrabajador} / CUIT: ${data.cuitTrabajador}`,
                    `Profesión: ${data.profesionTrabajador} - CCT: ${data.cctAplicable}`,
                    `Fecha Ingreso: ${data.fechaIngreso} - Fecha Egreso: ${data.fechaEgreso}`,
                ];

                // Modificación: Asegurar que cada elemento de la lista sea un string
                doc.text(workerData.map(item => String(item)), margin, y, { lineHeightFactor: 1.5, maxWidth: maxWidth });
                y += (workerData.length * lineHeight * 0.75) + 5;


                // 3. DETALLE DE RUBROS
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(31, 58, 101); // Navy
                doc.text("DETALLE DE RUBROS Y MONTOS", margin, y);
                y += lineHeight;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                // Draw table lines and entries
                doc.setDrawColor(212, 173, 107); // Gold
                doc.setLineWidth(0.5);
                doc.line(margin, y, margin + maxWidth, y); // Top line

                const rubros = [
                    { name: 'MRMNyH (Sueldo Base)', value: formatter.format(data.mrmnyh) },
                    { name: 'Tope Salarial CCT Aplicado', value: formatter.format(data.topeSalarialDisplay) },
                    { name: 'Antigüedad Reconocida', value: String(data.antiguedadDisplay) }, // Asegurar string
                    { name: 'Base de Cálculo (Art. 245)', value: getRubroText('res-base-calculo') },
                    { name: 'Indemnización por Antigüedad', value: getRubroText('res-antiguedad-monto') },
                    { name: 'Indemnización por Preaviso (+ SAC y Vacaciones)', value: getRubroText('res-preaviso-monto') },
                    { name: 'Integración Mes Despido (+ SAC)', value: getRubroText('res-integracion-monto') },
                    { name: 'Vacaciones No Gozadas Proporcionales', value: getRubroText('res-vacaciones-monto') },
                    { name: 'SAC Proporcional sobre Haberes', value: getRubroText('res-sac-proporcional') },
                    { name: 'Deuda por Diferencias Salariales (Pestaña 1)', value: getRubroText('res-diferencias-deuda'), color: '#1F3A65' },
                    { name: 'SUBTOTAL BRUTO SIN MULTAS', value: getRubroText('res-subtotal-bruto'), bold: true },
                ];
                
                // Add multas only if checked (using the visibility of the results rows)
                if (!document.getElementById('res-multa-2-row').classList.contains('hidden')) {
                    rubros.push({ name: 'Multa Art. 2 Ley 25.323 (50% sobre Indemnización Base)', value: getRubroText('res-multa-2') });
                }
                if (!document.getElementById('res-multa-80-row').classList.contains('hidden')) {
                    rubros.push({ name: 'Multa Art. 80 LCT (3 MRMNyH)', value: getRubroText('res-multa-80') });
                }
                if (!document.getElementById('res-multa-132bis-row').classList.contains('hidden')) {
                    rubros.push({ name: 'Multa Art. 132 bis LCT (Duplicación)', value: getRubroText('res-multa-132bis-monto') });
                }

                rubros.push(
                    { name: `Intereses Moratorios Aplicados (${data.interesAnual}%)`, value: getRubroText('res-intereses'), color: '#33A03E' },
                    { name: 'TOTAL ESTIMADO FINAL RECLAMABLE', value: getRubroText('res-total-final'), bold: true, size: 14, color: '#1F3A65' }
                );

                rubros.forEach(item => {
                    y += lineHeight;

                    doc.setFont('helvetica', item.bold ? 'bold' : 'normal');
                    // Use RGB values for color settings in jsPDF
                    const hexToRgb = (hex) => {
                        let bigint = parseInt(hex.slice(1), 16);
                        let r = (bigint >> 16) & 255;
                        let g = (bigint >> 8) & 255;
                        let b = bigint & 255;
                        return [r, g, b];
                    };
                    
                    // Modificación: Setear color en jsPDF con RGB
                    const rgbColor = item.color ? hexToRgb(item.color) : [0, 0, 0];
                    doc.setTextColor(rgbColor[0], rgbColor[1], rgbColor[2]);

                    doc.setFontSize(item.size || 10);

                    // Left Column (Rubro Name)
                    doc.text(String(item.name), margin + 2, y);
                    // Right Column (Amount)
                    doc.text(String(item.value), margin + maxWidth - 2, y, { align: 'right' });

                    if (item.name === 'TOTAL ESTIMADO FINAL RECLAMABLE') {
                        doc.setDrawColor(31, 58, 101); // Navy
                        doc.setLineWidth(0.8);
                        doc.line(margin, y + 1, margin + maxWidth, y + 1); // Final line
                    }
                });

                y += 5;

                // 4. FOOTER / DISCLAIMER
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(100); // Gray (Simplified: jsPDF takes a number for gray scale)
                doc.text(`Generado el: ${new Date().toLocaleDateString('es-AR')} a las ${new Date().toLocaleTimeString('es-AR')}.`, margin, doc.internal.pageSize.height - 10);
                // LÍNEA ELIMINADA: doc.text("Este informe es una ESTIMACIÓN preliminar. Consulte a un profesional para la liquidación final y aplicación de la legislación vigente.", margin, doc.internal.pageSize.height - 5);


                doc.save(`Liquidacion_NanciDeMoraiz_${data.nombreTrabajador.replace(/\s/g, '_')}.pdf`);
            } catch (error) {
                console.error("Error al generar el PDF:", error);
                // Si la excepción es el error de argumento, mostramos un mensaje específico
                const errorMessage = error.message.includes("Invalid argument passed") 
                    ? "Error de formato de datos en el informe. Verifique que todos los campos de entrada estén calculados."
                    : error.message;

                showModal('Error de Generación de PDF', 'Hubo un error al intentar crear el documento. Asegúrese de haber calculado la liquidación final primero. Detalle: ' + errorMessage);
            }
        };
        
    </script>

</body>
</html>




