<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Indemnizaciones Laborales</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and readability */
        :root {
            --primary-color: #2563eb; /* blue-600 */
            --secondary-color: #f59e0b; /* amber-500 */
            --background-color: #f9fafb; /* gray-50 */
            --card-background: #ffffff;
            --text-color: #1f2937; /* gray-800 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        .result-box {
            background-color: #e5e7eb; /* gray-200 */
        }
        .main-title {
            color: var(--primary-color);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold main-title mb-6 text-center">Calculadora de Liquidación y Diferencias Salariales (LCT)</h1>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center mb-8 p-1 bg-white rounded-lg shadow-md">
            <button id="tab-btn-diferencias-salariales" onclick="changeTab('diferencias-salariales')" class="tab-button active flex-1 px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200">
                1. Diferencias Salariales (Base de Reclamo)
            </button>
            <button id="tab-btn-indemnizacion" onclick="changeTab('indemnizacion')" class="tab-button flex-1 px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200">
                2. Liquidación Final (Indemnización y Multas)
            </button>
            <button id="tab-btn-guia-uso" onclick="changeTab('guia-uso')" class="tab-button flex-1 px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200">
                3. Guía de Uso y Fundamentos
            </button>
        </div>

        <!-- FIREBASE & CORE SETUP (Keep at start of script block) -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Fallback or empty config */ };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.userId = null;

            // Global State Variables
            window.currentDifferencesResult = 0;
            window.isAuthReady = false;

            // Global helper to show the custom modal
            window.showModal = (title, message) => {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                document.getElementById('custom-modal').classList.remove('hidden');
            };

            window.hideModal = () => {
                document.getElementById('custom-modal').classList.add('hidden');
            };

            // Authentication Initialization
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    window.isAuthReady = true;
                    // Start listening for data once auth is ready
                    listenForData();
                } else {
                    // Sign in anonymously if no user is found
                    signInAnonymously(window.auth).catch(error => {
                        console.error("Firebase Sign In Error:", error);
                        window.showModal('Error de Conexión', 'No se pudo iniciar sesión en la base de datos para guardar el estado. ' + error.message);
                    });
                }
            });

            // Firestore Data Listener (Saves and loads basic state)
            function listenForData() {
                if (!window.db || !window.userId) return;

                const docRef = doc(window.db, "artifacts", appId, "users", window.userId, "calculadora", "state");

                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists() && window.isAuthReady) {
                        const data = docSnap.data();
                        document.getElementById('mrmnyh-sueldo').value = data.mrmnyh || '';
                        document.getElementById('tope-salarial').value = data.topeSalarial || '';
                        // You can load other fields here if needed
                    }
                }, (error) => {
                    console.error("Firestore Error:", error);
                });
            }

            // Function to save the MRMNyH and Tope Salarial
            window.saveBasicState = async () => {
                if (!window.db || !window.userId || !window.isAuthReady) return;

                try {
                    const dataToSave = {
                        mrmnyh: document.getElementById('mrmnyh-sueldo').value,
                        topeSalarial: document.getElementById('tope-salarial').value
                        // Add other fields you want to save
                    };
                    const docRef = doc(window.db, "artifacts", appId, "users", window.userId, "calculadora", "state");
                    await setDoc(docRef, dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving state:", error);
                }
            };
        </script>


        <!-- TAB: 1. Diferencias Salariales (Base de Reclamo) -->
        <div id="diferencias-salariales-tab" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-2 text-gray-700">1. Diferencias Salariales (Horas, Feriados)</h2>
            <p class="mb-4 text-sm text-gray-600">Calcula la deuda del empleador por horas nocturnas y suplementarias para integrarla a la liquidación final.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Sueldo Bruto Mensual (Base de Cálculo) -->
                <div class="input-group">
                    <label for="sueldo-bruto-mes" class="block text-sm font-medium text-gray-700">Sueldo Bruto Mensual a Recalcular (MRMNyH)</label>
                    <input type="number" id="sueldo-bruto-mes" placeholder="Ej: 1800000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                    <p class="text-xs text-gray-500 mt-1">Sueldo percibido por el trabajador en el mes a reclamar (el más alto del último año para horas extras).</p>
                </div>

                <!-- **NUEVO CAMPO: Base Horaria** -->
                <div class="input-group">
                    <label for="base-horaria" class="block text-sm font-medium text-gray-700">Base Horaria Mensual del CCT</label>
                    <input type="number" id="base-horaria" value="200" min="168" max="200" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                    <p class="text-xs text-gray-500 mt-1">Horas mensuales que establece el Convenio (ej: 200, 192, 180). Se usará para calcular el valor de la hora normal (Sueldo / Nro de Horas).</p>
                </div>
                
                <!-- Meses a Reclamar -->
                <div class="input-group">
                    <label for="meses-reclamar" class="block text-sm font-medium text-gray-700">Meses a Reclamar (Prescripción LCT)</label>
                    <input type="number" id="meses-reclamar" value="24" min="1" max="24" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                    <p class="text-xs text-gray-500 mt-1">Máximo 24 meses (2 años) hacia atrás para deudas salariales.</p>
                </div>

                <!-- Horario de Trabajo Habitual -->
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700">Horario de Trabajo Habitual (Entrada - Salida)</label>
                    <div class="flex space-x-2 mt-1">
                        <input type="time" id="hora-entrada" value="09:00" class="block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                        <input type="time" id="hora-salida" value="17:00" class="block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Se usará para calcular automáticamente las horas nocturnas (21:00 a 06:00).</p>
                </div>

                <!-- Horas Extras 50% -->
                <div class="input-group">
                    <label for="horas-extras-50" class="block text-sm font-medium text-gray-700">Horas Extras al 50% No Abonadas (TOTAL)</label>
                    <input type="number" id="horas-extras-50" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                    <p class="text-xs text-gray-500 mt-1">Suma de horas extras del 50% (lunes a sábado 13:00) en el período reclamado.</p>
                </div>

                <!-- Horas Extras 100% -->
                <div class="input-group">
                    <label for="horas-extras-100" class="block text-sm font-medium text-gray-700">Horas Extras al 100% No Abonadas (TOTAL)</label>
                    <input type="number" id="horas-extras-100" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                    <p class="text-xs text-gray-500 mt-1">Suma de horas extras del 100% (sábados post 13:00, domingos) en el período reclamado.</p>
                </div>

                <!-- Feriados Trabajados (Manual) -->
                <div class="input-group">
                    <label for="feriados-trabajados" class="block text-sm font-medium text-gray-700">Feriados Trabajados y NO Abonados (Cantidad)</label>
                    <input type="number" id="feriados-trabajados" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" required>
                    <p class="text-xs text-gray-500 mt-1">Cantidad total de feriados trabajados y no abonados en el período reclamado.</p>
                </div>

            </div>

            <button onclick="calculateSalaryDifferences()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 mt-6 shadow-lg">
                CALCULAR DIFERENCIAS SALARIALES Y CONTINUAR →
            </button>

            <!-- Display Results -->
            <div id="diferencias-results" class="mt-8 p-4 bg-gray-100 rounded-lg hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Resultado de la Deuda Salarial Total</h3>
                <div class="flex justify-between items-center py-2 border-b">
                    <span class="text-sm font-medium text-gray-600">Monto Total de Diferencias Reclamadas (24 meses)</span>
                    <span id="resultado-diferencias" class="text-lg font-bold text-red-600">$ 0.00</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">Este monto se trasladará a la Pestaña 2 para su inclusión en la Liquidación Final.</p>
            </div>
        </div>

        <!-- TAB: 2. Liquidación Final (Indemnización y Multas) -->
        <div id="indemnizacion-tab" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-2 text-gray-700">2. Liquidación Final (Indemnización, Multas, Intereses)</h2>
            <p class="mb-4 text-sm text-gray-600">Calcula la liquidación final, incluyendo las multas e intereses basados en la LCT.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Data Input Fields -->
                <div class="input-group">
                    <label for="fecha-ingreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="fecha-ingreso" value="2022-01-01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div class="input-group">
                    <label for="fecha-egreso" class="block text-sm font-medium text-gray-700">Fecha de Egreso / Fecha de Liquidación</label>
                    <input type="date" id="fecha-egreso" value="2024-01-01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div class="input-group">
                    <label for="mrmnyh-sueldo" class="block text-sm font-medium text-gray-700">MRMNyH (Art. 245) - Sueldo Base</label>
                    <input type="number" id="mrmnyh-sueldo" placeholder="Sueldo más alto del último año" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>
                <div class="input-group">
                    <label for="tope-salarial" class="block text-sm font-medium text-gray-700">Tope Salarial CCT (Art. 245)</label>
                    <input type="number" id="tope-salarial" placeholder="Tope Salarial o Sueldo si es igual" onchange="saveBasicState()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                </div>

                <!-- Nuevo Campo para Diferencias Salariales -->
                <div class="input-group md:col-span-2">
                    <label for="deuda-diferencias" class="block text-sm font-medium text-red-700">Deuda por Diferencias Salariales (Horas, etc.)</label>
                    <input type="number" id="deuda-diferencias" value="0" class="mt-1 block w-full rounded-md border-red-400 shadow-sm p-2 border bg-red-50 text-red-800 font-bold" readonly>
                    <p class="text-xs text-gray-500 mt-1">Este valor se carga automáticamente desde la Pestaña 1.</p>
                </div>

                <div class="input-group md:col-span-2 border-t pt-4">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Multas e Intereses</h3>
                    <!-- Multa Art. 132 bis LCT -->
                    <div class="flex items-center mb-2">
                        <input id="multa-132bis" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="multa-132bis" class="ml-2 block text-sm font-medium text-gray-700">Multa Art. 132 bis LCT (Duplicación por falta de aportes)</label>
                    </div>

                    <!-- Intereses Moratorios -->
                    <div class="flex items-center space-x-4 mt-4">
                        <label for="interes-anual" class="text-sm font-medium text-gray-700">Tasa de Interés Moratorio Anual (ej: 30%)</label>
                        <input type="number" id="interes-anual" value="0" min="0" max="100" class="w-20 rounded-md border-gray-300 shadow-sm p-2 border text-right">
                        <span class="text-sm">%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Se aplica sobre el Total Bruto sin Multas, multiplicado por los años de antigüedad (simulación de intereses judiciales).</p>
                </div>

            </div>

            <button onclick="calculateSeverance()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 mt-6 shadow-lg">
                CALCULAR LIQUIDACIÓN FINAL
            </button>

            <!-- Results Section -->
            <div id="indemnizacion-results" class="mt-8 p-6 bg-gray-50 rounded-xl border border-gray-300 hidden">
                <h3 class="text-xl font-bold mb-4 text-blue-600">RESULTADO DE LA LIQUIDACIÓN</h3>
                <div class="space-y-3">
                    <div class="flex justify-between font-medium text-gray-700 py-1">
                        <span>Antigüedad (Años y Meses)</span>
                        <span id="res-antiguedad">0 años, 0 meses</span>
                    </div>
                    <div class="flex justify-between font-medium text-gray-700 py-1 border-t pt-2">
                        <span>Base de Cálculo Art. 245 (Tope Salarial vs. MRMNyH)</span>
                        <span id="res-base-calculo">$ 0.00</span>
                    </div>

                    <!-- Rubros Indemnizatorios -->
                    <div class="bg-blue-100 p-3 rounded-lg space-y-2">
                        <h4 class="text-md font-semibold text-blue-800">Indemnización Base</h4>
                        <div class="flex justify-between">
                            <span class="text-sm">Indemnización por Antigüedad (Art. 245)</span>
                            <span id="res-antiguedad-monto">$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Indemnización por Preaviso (con SAC y Vacaciones)</span>
                            <span id="res-preaviso-monto">$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Integración Mes Despido (Días / 30)</span>
                            <span id="res-integracion-monto">$ 0.00</span>
                        </div>
                    </div>

                    <!-- Rubros Adicionales/Deuda -->
                    <div class="bg-yellow-100 p-3 rounded-lg space-y-2">
                        <h4 class="text-md font-semibold text-yellow-800">Deudas y Otros Rubros</h4>
                        <div class="flex justify-between">
                            <span class="text-sm">Vacaciones No Gozadas (Días Proporcionales)</span>
                            <span id="res-vacaciones-monto">$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">SAC Proporcional sobre Haberes</span>
                            <span id="res-sac-proporcional">$ 0.00</span>
                        </div>
                        <div class="flex justify-between font-bold text-red-800">
                            <span class="text-sm">Deuda por Diferencias Salariales (Horas, Feriados)</span>
                            <span id="res-diferencias-deuda">$ 0.00</span>
                        </div>
                    </div>
                    
                    <!-- Subtotal y Multas -->
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between font-bold text-gray-800">
                            <span>SUBTOTAL BRUTO SIN MULTAS</span>
                            <span id="res-subtotal-bruto">$ 0.00</span>
                        </div>

                        <h4 class="text-md font-semibold text-red-800 pt-2">Multas LCT</h4>
                        <div class="flex justify-between">
                            <span class="text-sm">Multa Art. 2 Ley 25.323 (50% sobre Indemnización Base)</span>
                            <span id="res-multa-2">$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Multa Art. 80 LCT (3 x MRMNyH)</span>
                            <span id="res-multa-80">$ 0.00</span>
                        </div>
                        <div id="res-multa-132bis-row" class="flex justify-between hidden">
                            <span class="text-sm font-semibold text-red-900">Multa Art. 132 bis LCT (Duplicación por aportes)</span>
                            <span id="res-multa-132bis-monto" class="font-semibold text-red-900">$ 0.00</span>
                        </div>
                    </div>

                    <!-- Intereses y Total Final -->
                    <div class="border-t border-b py-4 mt-4 space-y-2">
                         <div class="flex justify-between font-bold text-green-700">
                            <span>Intereses Moratorios Aplicados</span>
                            <span id="res-intereses">$ 0.00</span>
                        </div>
                        <div class="flex justify-between text-xl font-extrabold text-blue-700">
                            <span>TOTAL ESTIMADO FINAL RECLAMABLE</span>
                            <span id="res-total-final">$ 0.00</span>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-4">NOTA: Este total es una estimación. Los intereses y la aplicación de multas deben ser confirmados por un profesional.</p>
                <button onclick="generatePDF()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 mt-4 shadow-md">
                    GENERAR INFORME PDF
                </button>
            </div>
        </div>

        <!-- TAB: 3. Guía de Uso y Fundamentos -->
        <div id="guia-uso-tab" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-2 text-gray-700">3. Guía de Uso y Fundamentos Legales</h2>
            <div class="space-y-6 text-gray-700">
                <section>
                    <h3 class="text-xl font-bold text-blue-600 mb-2">Paso a Paso para la Liquidación</h3>
                    <ol class="list-decimal list-inside space-y-2 ml-4">
                        <li>**Pestaña 1 (Diferencias Salariales):** Ingrese el Sueldo Bruto Mensual (MRMNyH) y la **Base Horaria del CCT (ej: 200)**. Luego, ingrese el total de las horas extras, nocturnas y feriados no abonados en los últimos 24 meses. Presione **CALCULAR** para obtener la Deuda Salarial Total.</li>
                        <li>**Pestaña 2 (Liquidación Final):** La deuda salarial se trasladará automáticamente al campo **"Deuda por Diferencias Salariales"**.</li>
                        <li>Complete las fechas de ingreso/egreso, el MRMNyH para indemnización y el Tope Salarial.</li>
                        <li>Seleccione las multas aplicables (Art. 2, Art. 80, Art. 132 bis) e ingrese una tasa de interés moratorio (sugerido por el profesional).</li>
                        <li>Presione **CALCULAR LIQUIDACIÓN FINAL** para obtener el monto total reclamable.</li>
                    </ol>
                </section>

                <section>
                    <h3 class="text-xl font-bold text-blue-600 mb-2">Fundamento del Cálculo de Diferencias Salariales</h3>
                    <p class="text-sm italic">La calculadora se basa en la Ley de Contrato de Trabajo (LCT) y asume que el empleador solo adeuda el recargo (la hora simple ya fue abonada).</p>
                    
                    <div class="space-y-3 mt-3 p-4 bg-gray-100 rounded-lg">
                        <h4 class="font-semibold text-lg text-gray-800">Valor de la Hora Normal</h4>
                        <p class="text-sm">La hora normal se calcula como: $ \text{MRMNyH} / \text{Base Horaria Mensual} $ (ej: 200). Este es el valor base para todos los recargos.</p>

                        <h4 class="font-semibold text-lg text-gray-800">Horas Nocturnas (Art. 200 LCT)</h4>
                        <p class="text-sm">Se considera trabajo nocturno el realizado entre las **21:00 y 06:00**. La jornada nocturna no puede exceder las **7 horas** (una hora menos que la diurna de 8 horas). Esto equivale a un recargo del **$13.33\%$** (se pagan $8$ horas por $7$ horas trabajadas).</p>
                        <p class="text-sm font-semibold">Fórmula de la Diferencia Reclamada: $ \text{Valor Hora Normal} \times 0.1333 $</p>

                        <h4 class="font-semibold text-lg text-gray-800">Horas Extras y Feriados (Art. 201 LCT)</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-sm">
                            <li>**Horas Extras 50%:** Aplica para días comunes (lunes a sábado 13:00). La diferencia reclamada es el recargo del $50\%$. Fórmula: $ \text{Valor Hora Normal} \times 0.50 $</li>
                            <li>**Horas Extras 100%:** Aplica para feriados, domingos o sábados después de las 13:00. La diferencia reclamada es el recargo del $100\%$. Fórmula: $ \text{Valor Hora Normal} \times 1.00 $</li>
                            <li>**Feriados No Abonados:** Aplica para el día feriado trabajado y no liquidado correctamente (pago del 100% adicional). Fórmula: $ \text{Valor Hora Normal} \times 1.00 $</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h3 class="text-xl font-bold text-blue-600 mb-2">Fundamento de Multas Adicionales</h3>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li>**Multa Art. 2 Ley 25.323 (50%):** Se aplica sobre las indemnizaciones por antigüedad, preaviso e integración del mes de despido cuando el trabajador se ve obligado a iniciar acciones judiciales para cobrarlas.</li>
                        <li>**Multa Art. 80 LCT (3 x MRMNyH):** Se aplica cuando el empleador no entrega al trabajador los certificados de trabajo/aportes (Art. 80 LCT) al momento de extinguirse la relación.</li>
                        <li>**Multa Art. 132 bis LCT (Duplicación):** Si el empleador retuvo los aportes previsionales o sindicales del sueldo del trabajador y no los depositó, las indemnizaciones se duplican (indemnización por antigüedad, preaviso, e integración del mes de despido).</li>
                    </ul>
                </section>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Alerts/Errors (Replaces alert()) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600">Error</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Mensaje de error o alerta.</p>
            <button onclick="hideModal()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Aceptar</button>
        </div>
    </div>


    <!-- MAIN JAVASCRIPT LOGIC -->
    <script type="text/javascript">
        // Global utility function to format currency
        const formatter = new Intl.NumberFormat('es-AR', {
            style: 'currency',
            currency: 'ARS',
            minimumFractionDigits: 2,
        });

        // Function to switch tabs
        window.changeTab = (tabName) => {
            const tabs = ['diferencias-salariales', 'indemnizacion', 'guia-uso'];
            tabs.forEach(tab => {
                document.getElementById(`${tab}-tab`).classList.add('hidden');
                document.getElementById(`tab-btn-${tab}`).classList.remove('active');
                document.getElementById(`tab-btn-${tab}`).classList.remove('bg-blue-600', 'text-white');
                document.getElementById(`tab-btn-${tab}`).classList.add('text-gray-600');
            });

            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active', 'bg-blue-600', 'text-white');
            document.getElementById(`tab-btn-${tabName}`).classList.remove('text-gray-600');
        };

        // Function to calculate the difference in hours between two times
        function calculateHoursDifference(start, end) {
            const startParts = start.split(':').map(Number);
            const endParts = end.split(':').map(Number);

            const startDate = new Date(0, 0, 0, startParts[0], startParts[1]);
            let endDate = new Date(0, 0, 0, endParts[0], endParts[1]);

            // If end time is earlier than start time, it means the shift crosses midnight
            if (endDate <= startDate) {
                endDate.setDate(endDate.getDate() + 1); // Add one day
            }

            return (endDate - startDate) / (1000 * 60 * 60); // Difference in hours
        }

        /**
         * --------------------------------------------------------
         * PESTAÑA 1: CALCULADORA DE DIFERENCIAS SALARIALES
         * --------------------------------------------------------
         */
        window.calculateSalaryDifferences = () => {
            const sueldoBrutoMensual = parseFloat(document.getElementById('sueldo-bruto-mes').value || 0);
            const mesesReclamar = parseInt(document.getElementById('meses-reclamar').value || 0);
            const horaEntrada = document.getElementById('hora-entrada').value;
            const horaSalida = document.getElementById('hora-salida').value;
            const horasExtras50 = parseFloat(document.getElementById('horas-extras-50').value || 0);
            const horasExtras100 = parseFloat(document.getElementById('horas-extras-100').value || 0);
            const feriadosTrabajados = parseInt(document.getElementById('feriados-trabajados').value || 0);
            const baseHorariaCCT = parseInt(document.getElementById('base-horaria').value || 200); // NEW INPUT

            if (!sueldoBrutoMensual || !mesesReclamar || mesesReclamar > 24 || baseHorariaCCT < 168) {
                showModal('Datos Incompletos', 'Por favor, ingrese un Sueldo Bruto válido, la cantidad de meses (máx. 24) y una Base Horaria del CCT (mín. 168).');
                return;
            }

            // 1. CÁLCULO DE VALOR DE HORA NORMAL
            // Se utiliza la Base Horaria del CCT ingresada por el usuario (ej: 200, 192)
            const valorHoraNormal = sueldoBrutoMensual / baseHorariaCCT;

            // 2. CÁLCULO DE HORAS NOCTURNAS (21:00 a 06:00)
            const NOCTURNO_START = 21;
            const NOCTURNO_END = 6;
            const ADICIONAL_NOCTURNO = 0.1333; // 13.33% diferencia a reclamar

            let horasNocturnasPorDia = 0;
            let totalHorasTrabajadas = calculateHoursDifference(horaEntrada, horaSalida);

            // Simplificación: Asumimos que el horario se repite 25 días/mes (o 21 días laborables, dependiendo del CCT)
            // Para el cálculo de diferencia salarial, tomaremos 21 días laborales/mes (Lunes a Viernes + 1 Sábado).
            const DIAS_LABORABLES_MES = 21;

            // Logic to check how many hours fall within the 21:00 - 06:00 range
            for (let h = Math.floor(totalHorasTrabajadas); h > 0; h--) {
                let currentHour = new Date(0, 0, 0, new Date(0, 0, 0, parseFloat(horaEntrada.split(':')[0]) + h - 1, parseFloat(horaEntrada.split(':')[1])).getHours(), 0);

                let hourOfDay = currentHour.getHours();

                if (hourOfDay >= NOCTURNO_START || hourOfDay < NOCTURNO_END) {
                    horasNocturnasPorDia++;
                }
            }

            const totalHorasNocturnasPeriodo = horasNocturnasPorDia * DIAS_LABORABLES_MES * mesesReclamar;
            
            // Diferencia por Horas Nocturnas (solo el adicional)
            const diferenciaNocturna = totalHorasNocturnasPeriodo * valorHoraNormal * ADICIONAL_NOCTURNO;
            
            // 3. CÁLCULO DE HORAS EXTRAS Y FERIADOS (Diferencia a reclamar)

            // Horas Extras 50% (Diferencia = 50% del valor hora)
            const diferenciaExtras50 = horasExtras50 * valorHoraNormal * 0.50;

            // Horas Extras 100% (Diferencia = 100% del valor hora)
            const diferenciaExtras100 = horasExtras100 * valorHoraNormal * 1.00;

            // Feriados no abonados (Diferencia = 100% del valor hora, asumiendo que el día de descanso fue pago simple)
            // Asumimos 8 horas por feriado
            const diferenciaFeriados = feriadosTrabajados * 8 * valorHoraNormal * 1.00;


            // 4. TOTALIZACIÓN
            const totalDiferenciasSalariales = diferenciaNocturna + diferenciaExtras50 + diferenciaExtras100 + diferenciaFeriados;
            
            // Update Global State
            window.currentDifferencesResult = totalDiferenciasSalariales;

            // Display Results in Tab 1
            document.getElementById('resultado-diferencias').textContent = formatter.format(totalDiferenciasSalariales);
            document.getElementById('diferencias-results').classList.remove('hidden');

            // Pass result to Tab 2 and switch
            document.getElementById('deuda-diferencias').value = totalDiferenciasSalariales.toFixed(2);
            
            // Switch to Liquidación Final tab
            showModal('Cálculo Realizado', `La Deuda Salarial de ${formatter.format(totalDiferenciasSalariales)} ha sido calculada y transferida a la Pestaña 2 para finalizar la liquidación.`);
            changeTab('indemnizacion');
        };


        /**
         * --------------------------------------------------------
         * PESTAÑA 2: CALCULADORA DE INDEMNIZACIONES FINALES
         * --------------------------------------------------------
         */
        window.calculateSeverance = () => {
            const fechaIngreso = document.getElementById('fecha-ingreso').value;
            const fechaEgreso = document.getElementById('fecha-egreso').value;
            let mrmnyh = parseFloat(document.getElementById('mrmnyh-sueldo').value || 0);
            let topeSalarial = parseFloat(document.getElementById('tope-salarial').value || 0);
            const deudaDiferencias = parseFloat(document.getElementById('deuda-diferencias').value || 0);
            const multa132bis = document.getElementById('multa-132bis').checked;
            const interesAnual = parseFloat(document.getElementById('interes-anual').value || 0) / 100;

            if (!fechaIngreso || !fechaEgreso || !mrmnyh) {
                showModal('Datos Incompletos', 'Por favor, complete las Fechas de Ingreso/Egreso y el MRMNyH para calcular la liquidación.');
                return;
            }

            const start = new Date(fechaIngreso + "T00:00:00");
            const end = new Date(fechaEgreso + "T00:00:00");

            if (start >= end) {
                showModal('Error de Fecha', 'La fecha de egreso debe ser posterior a la fecha de ingreso.');
                return;
            }

            // A. CÁLCULO DE ANTIGÜEDAD Y BASE DE CÁLCULO
            const diffTime = Math.abs(end - start);
            const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
            const years = Math.floor(diffYears);
            const months = Math.floor((diffYears - years) * 12);

            // Para Indemnización por Antigüedad: Art. 245
            let antiguedadAnios = years;
            // Si la antigüedad es 3 meses o más en el último año, se redondea al año superior.
            if (months >= 3) {
                antiguedadAnios += 1;
            } else if (antiguedadAnios === 0 && months < 3) {
                 antiguedadAnios = 1; // Mínimo 1 año de indemnización
            }

            // Determinar la Base de Cálculo (BCC)
            let baseCalculoArt245 = mrmnyh;
            if (topeSalarial > 0) {
                // El BCC es el menor entre el MRMNyH y el Tope Salarial del CCT (o 3 veces el tope si es menor)
                baseCalculoArt245 = Math.min(mrmnyh, topeSalarial); // Simplificado
            }

            // B. RUBROS INDEMNIZATORIOS BASE
            let indemAntiguedad = baseCalculoArt245 * antiguedadAnios;

            // Preaviso (Art. 232 LCT) - Mínimo 1 mes si antig. es < 5 años, 2 meses si es >= 5 años
            let mesesPreaviso = antiguedadAnios < 5 ? 1 : 2;
            let indemPreaviso = baseCalculoArt245 * mesesPreaviso;

            // Integración Mes Despido (Art. 233 LCT)
            const daysInMonth = 30;
            const dayOfEgress = end.getDate();
            const daysToIntegrate = daysInMonth - dayOfEgress;
            let indemIntegracion = (baseCalculoArt245 / daysInMonth) * daysToIntegrate;
            if (indemIntegracion < 0) indemIntegracion = 0; // Si egresa el 30, es 0

            // C. OTROS RUBROS
            // Vacaciones No Gozadas (Art. 150/156 LCT)
            const daysWorkedThisYear = Math.ceil((end - new Date(end.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24));
            const daysEntitlement = Math.min(28, 14 + Math.floor(years / 5) * 7); // Mín 14, +7 cada 5 años (simplif.)
            const proportionalVacationDays = (daysWorkedThisYear / 365) * daysEntitlement;
            let indemVacaciones = (baseCalculoArt245 / 25) * proportionalVacationDays;

            // SAC Proporcional (Art. 121 LCT)
            const monthsWorkedThisSemester = end.getMonth() >= 6 ? (end.getMonth() - 5) : (end.getMonth() + 1);
            let indemSacProporcional = (mrmnyh * monthsWorkedThisSemester) / 12;

            // SAC sobre Indemnización por Preaviso y Integración (se pagan en la integración)
            // Preaviso y Integración generan SAC proporcional y Vacaciones, ya que se consideran tiempo trabajado
            let sacPreaviso = indemPreaviso * 0.0833; // 8.33% de SAC sobre Preaviso
            let vacPreaviso = indemPreaviso * 0.0417; // 4.17% de Vacaciones sobre Preaviso (simplificado)
            indemPreaviso += sacPreaviso + vacPreaviso;


            // D. SUBTOTAL BRUTO
            const subTotalBase = indemAntiguedad + indemPreaviso + indemIntegracion + indemVacaciones + indemSacProporcional;
            let subTotalConDeuda = subTotalBase + deudaDiferencias;

            // E. MULTAS
            let multasTotal = 0;
            let multa25323Art2 = subTotalBase * 0.50; // 50% sobre Indemnización Base
            let multa25323Art80 = mrmnyh * 3; // 3 sueldos por falta de entrega de certificado
            let multa132bisMonto = 0;

            if (multa132bis) {
                // Duplica la Indemnización Base (Antigüedad + Preaviso + Integración)
                multa132bisMonto = indemAntiguedad + indemPreaviso + indemIntegracion;
                multasTotal += multa132bisMonto;
                document.getElementById('res-multa-132bis-row').classList.remove('hidden');
            } else {
                document.getElementById('res-multa-132bis-row').classList.add('hidden');
            }
            
            multasTotal += multa25323Art2 + multa25323Art80;

            // F. INTERESES MORATORIOS
            let totalIntereses = 0;
            if (interesAnual > 0) {
                // Cálculo simple: (Total Bruto sin Multas) * Tasa * Años de Antigüedad
                totalIntereses = subTotalConDeuda * interesAnual * years;
            }

            // G. TOTAL FINAL RECLAMABLE
            const totalFinal = subTotalConDeuda + multasTotal + totalIntereses;


            // H. MOSTRAR RESULTADOS
            document.getElementById('res-antiguedad').textContent = `${years} años, ${months} meses`;
            document.getElementById('res-base-calculo').textContent = formatter.format(baseCalculoArt245);
            document.getElementById('res-antiguedad-monto').textContent = formatter.format(indemAntiguedad);
            document.getElementById('res-preaviso-monto').textContent = formatter.format(indemPreaviso);
            document.getElementById('res-integracion-monto').textContent = formatter.format(indemIntegracion);
            document.getElementById('res-vacaciones-monto').textContent = formatter.format(indemVacaciones);
            document.getElementById('res-sac-proporcional').textContent = formatter.format(indemSacProporcional);
            document.getElementById('res-diferencias-deuda').textContent = formatter.format(deudaDiferencias);
            document.getElementById('res-subtotal-bruto').textContent = formatter.format(subTotalConDeuda);
            document.getElementById('res-multa-2').textContent = formatter.format(multa25323Art2);
            document.getElementById('res-multa-80').textContent = formatter.format(multa25323Art80);
            document.getElementById('res-multa-132bis-monto').textContent = formatter.format(multa132bisMonto);
            document.getElementById('res-intereses').textContent = formatter.format(totalIntereses);
            document.getElementById('res-total-final').textContent = formatter.format(totalFinal);

            document.getElementById('indemnizacion-results').classList.remove('hidden');

            // Save state of MRMNyH and Tope Salarial
            window.saveBasicState();
        };

        /**
         * --------------------------------------------------------
         * GENERACIÓN DE PDF
         * --------------------------------------------------------
         */
        window.generatePDF = async () => {
            // Cargar jsPDF solo cuando se presiona el botón, usando el constructor global expuesto por el CDN.
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                 showModal('Error de PDF', 'Librería de PDF no disponible. Por favor, intente recargar la página.');
                 return;
            }

            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF();

            const totalFinal = document.getElementById('res-total-final').textContent;
            const baseCalculo = document.getElementById('res-base-calculo').textContent;
            const antiguedad = document.getElementById('res-antiguedad').textContent;
            const fechaIngreso = document.getElementById('fecha-ingreso').value;
            const fechaEgreso = document.getElementById('fecha-egreso').value;

            // Datos de la Pestaña 1
            const totalDiferencias = document.getElementById('resultado-diferencias').textContent;
            const sueldoBaseDiff = document.getElementById('sueldo-bruto-mes').value;
            const baseHorariaCCT = document.getElementById('base-horaria').value;
            const mesesReclamo = document.getElementById('meses-reclamar').value;
            

            let y = 15;
            doc.setFontSize(18);
            doc.text("INFORME DE LIQUIDACIÓN LABORAL (ESTIMATIVO)", 105, y, null, null, "center");
            y += 10;
            doc.line(20, y, 190, y);
            y += 8;

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("DATOS PRINCIPALES:", 20, y);
            y += 6;
            doc.setFont(undefined, 'normal');
            doc.text(`Fecha de Ingreso: ${fechaIngreso}`, 20, y);
            doc.text(`Fecha de Egreso: ${fechaEgreso}`, 110, y);
            y += 6;
            doc.text(`Antigüedad Calculada: ${antiguedad}`, 20, y);
            doc.text(`Base de Cálculo (MRMNyH o Tope): ${baseCalculo}`, 110, y);
            y += 10;

            // Detalles de Diferencias Salariales
            doc.setFont(undefined, 'bold');
            doc.text("DETALLE DE DEUDA SALARIAL (Pestaña 1):", 20, y);
            y += 6;
            doc.setFont(undefined, 'normal');
            doc.text(`Sueldo Base (MRMNyH): ${formatter.format(sueldoBaseDiff)}`, 20, y);
            doc.text(`Base Horaria CCT: ${baseHorariaCCT} horas`, 110, y);
            y += 6;
            doc.text(`Meses Reclamados: ${mesesReclamo}`, 20, y);
            doc.text(`TOTAL DEUDA SALARIAL: ${totalDiferencias}`, 110, y);
            y += 10;


            // Resumen de Rubros
            doc.setFont(undefined, 'bold');
            doc.text("RESUMEN DE INDEMNIZACIONES Y MULTAS:", 20, y);
            y += 8;

            const results = document.getElementById('indemnizacion-results').querySelectorAll('.flex.justify-between');
            
            results.forEach(row => {
                const label = row.querySelector('span:first-child').textContent.trim();
                const value = row.querySelector('span:last-child').textContent.trim();
                
                if (label && value && y < 270) {
                    doc.setFont(undefined, 'normal');
                    if (label.includes("SUBTOTAL") || label.includes("TOTAL ESTIMADO")) {
                        doc.setFont(undefined, 'bold');
                        doc.line(20, y - 2, 190, y - 2);
                    }
                    doc.text(label, 20, y);
                    doc.text(value, 190, y, null, null, "right");
                    y += 5;
                }
            });

            // Total Final
            y += 5;
            doc.line(20, y, 190, y);
            y += 6;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("TOTAL ESTIMADO FINAL:", 20, y);
            doc.text(totalFinal, 190, y, null, null, "right");

            y += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'italic');
            doc.text("NOTA: Este informe es una estimación basada en la Ley de Contrato de Trabajo (LCT) y no reemplaza la consulta con un abogado laboralista.", 20, y);

            doc.save("Liquidacion_Laboral_Estimativa.pdf");
        };

        // Initialize App on load
        window.onload = function() {
            // Attach the modal hide function to the button
            document.querySelector('#custom-modal button').onclick = window.hideModal;
            
            // Set default date for egreso (today) and ingreso (2 years ago)
            const today = new Date();
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(today.getFullYear() - 2);
            document.getElementById('fecha-egreso').value = today.toISOString().substring(0, 10);
            document.getElementById('fecha-ingreso').value = twoYearsAgo.toISOString().substring(0, 10);

            // Set default time (9 to 5)
            document.getElementById('hora-entrada').value = "09:00";
            document.getElementById('hora-salida').value = "17:00";
            
            // Initial tab selection
            changeTab('diferencias-salariales');
        };
    </script>
    
    <!-- jsPDF CDN MUST BE LOADED GLOBALLY FOR THE ASYNC IMPORT TO WORK CONSISTENTLY -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

</body>
</html>

